{% extends "base.html" %}

{% block title %}AI Model Security Scanner - ê²°ê³¼: {{ job.filename }}{% endblock %}

{% block content %}
<div class="result-header">
    <a href="/jobs" class="back-link">â† ëª©ë¡ìœ¼ë¡œ</a>
    <h1>ìŠ¤ìº” ê²°ê³¼</h1>
</div>

<div class="result-overview">
    <div class="result-status-card {% if job.pass_fail == 'PASS' %}status-pass{% else %}status-fail{% endif %}">
        <div class="status-icon">
            {% if job.pass_fail == 'PASS' %}âœ“{% else %}âœ—{% endif %}
        </div>
        <div class="status-text">
            <h2>{{ job.pass_fail or 'ì²˜ë¦¬ ì¤‘' }}</h2>
            <p>{{ job.fail_reason or 'ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤' }}</p>
        </div>
    </div>
</div>

<div class="result-details">
    <div class="info-card">
        <h3>ğŸ“ íŒŒì¼ ì •ë³´</h3>
        <table class="info-table">
            <tr>
                <th>íŒŒì¼ëª…</th>
                <td>{{ job.filename }}</td>
            </tr>
            <tr>
                <th>íŒŒì¼ í¬ê¸°</th>
                <td>{{ job.file_size | format_size }}</td>
            </tr>
            <tr>
                <th>SHA256</th>
                <td class="hash-value">{{ job.sha256 }}</td>
            </tr>
            <tr>
                <th>í™•ì¥ì</th>
                <td>{{ job.file_extension }}</td>
            </tr>
        </table>
    </div>

    <div class="info-card">
        <h3>â±ï¸ ì‹¤í–‰ ì •ë³´</h3>
        <table class="info-table">
            <tr>
                <th>Job ID</th>
                <td class="job-id">{{ job.job_id }}</td>
            </tr>
            <tr>
                <th>ì‹œì‘ ì‹œê°„</th>
                <td>{{ job.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            </tr>
            <tr>
                <th>ì™„ë£Œ ì‹œê°„</th>
                <td>{{ job.finished_at.strftime('%Y-%m-%d %H:%M:%S') if job.finished_at else '-' }}</td>
            </tr>
            <tr>
                <th>ìƒíƒœ</th>
                <td>
                    <span class="status-badge status-{{ job.status }}">
                        {{ job.status.upper() }}
                    </span>
                </td>
            </tr>
        </table>
    </div>

    <div class="info-card">
        <h3>ğŸ”§ ì‹¤í–‰ëœ ë„êµ¬</h3>
        <div class="tools-list">
            {% for tool in job.tools_run %}
            <div class="tool-item">
                <span class="tool-name">{{ tool }}</span>
                <span class="tool-version">v{{ job.tool_versions.get(tool, 'unknown') }}</span>
                <span class="tool-findings">{{ job.findings_by_tool.get(tool, 0) }} ë°œê²¬</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="info-card">
        <h3>ğŸ“Š ë°œê²¬ ìš”ì•½</h3>
        <div class="findings-summary">
            <div class="finding-stat total">
                <span class="stat-value">{{ job.total_findings }}</span>
                <span class="stat-label">ì´ ë°œê²¬</span>
            </div>
            {% for severity, count in job.findings_by_severity.items() %}
            <div class="finding-stat severity-{{ severity | lower }}">
                <span class="stat-value">{{ count }}</span>
                <span class="stat-label">{{ severity }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% if job.top_findings %}
<div class="findings-section">
    <h3>ğŸ” ì£¼ìš” ë°œê²¬ì‚¬í•­ (ìƒìœ„ {{ job.top_findings | length }}ê°œ)</h3>
    <div class="findings-list">
        {% for finding in job.top_findings %}
        <div class="finding-item severity-{{ finding.severity | lower }}">
            <div class="finding-header">
                <span class="finding-severity">{{ finding.severity }}</span>
                <span class="finding-tool">{{ finding.tool }}</span>
            </div>
            <p class="finding-message">{{ finding.message }}</p>
            {% if finding.details %}
            <details class="finding-details">
                <summary>ìƒì„¸ ì •ë³´</summary>
                <pre>{{ finding.details | tojson(indent=2) }}</pre>
            </details>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="artifacts-section">
    <h3>ğŸ“¦ ë‹¤ìš´ë¡œë“œ</h3>
    <div class="artifacts-grid">
        {% for artifact in artifacts %}
        <a href="/api/jobs/{{ job.job_id }}/download/{{ artifact.name }}" class="artifact-card">
            <span class="artifact-icon">
                {% if artifact.name.endswith('.json') %}ğŸ“„{% elif artifact.name.endswith('.zip') %}ğŸ“¦{% else %}ğŸ“{%
                endif %}
            </span>
            <span class="artifact-name">{{ artifact.name }}</span>
            <span class="artifact-size">{{ artifact.size }}</span>
        </a>
        {% endfor %}
    </div>
</div>

<div class="json-viewer-section">
    <h3>ğŸ“‹ ê²°ê³¼ JSON</h3>
    <div class="json-tabs">
        <button class="json-tab active" data-target="summary">Summary</button>
        {% for artifact in artifacts %}
        {% if artifact.name.endswith('.json') and artifact.name != 'summary.json' %}
        <button class="json-tab" data-target="{{ artifact.name }}">{{ artifact.name | replace('.json', '') }}</button>
        {% endif %}
        {% endfor %}
    </div>
    <div class="json-content" id="jsonContent">
        <pre id="jsonPretty">Click a tab to load JSON content</pre>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.json-tab');
        const jsonPretty = document.getElementById('jsonPretty');
        const jobId = '{{ job.job_id }}';

        tabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const target = tab.dataset.target;
                const filename = target === 'summary' ? 'summary.json' : target;

                try {
                    const response = await fetch(`/api/jobs/${jobId}/download/${filename}`);
                    const data = await response.json();
                    jsonPretty.textContent = JSON.stringify(data, null, 2);
                } catch (error) {
                    jsonPretty.textContent = 'Error loading JSON: ' + error.message;
                }
            });
        });

        // Load summary by default
        if (tabs.length > 0) {
            tabs[0].click();
        }
    });
</script>
{% endblock %}